@using WelpenWache.Core.Features.Intern.Models
@using WelpenWache.Core
@using WelpenWache.Components.Styling

<MudDialog>
    <DialogContent>
        <MudStack Spacing="3">
            @* Header mit Datum und Statistik *@
            <MudPaper Elevation="0" Class="pa-4 intern-dialog-header">
                <MudStack Spacing="2">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Large"/>
                        <MudText Typo="Typo.h6">@Date</MudText>
                    </MudStack>
                    <MudText Typo="Typo.body2" Style="opacity: 0.9;">
                        @Count Praktikant@(Count != 1 ? "en" : "") anwesend
                    </MudText>
                </MudStack>
            </MudPaper>

            @* Praktikanten-Liste *@
            <MudGrid Spacing="2">
                @foreach (var intern in Interns)
                {
                    <MudItem xs="12" sm="6" md="4">
                        <MudPaper Elevation="2" Class="pa-3 intern-dialog-card">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                                @* Avatar mit Initialen *@
                                <MudAvatar Color="Color.Primary" Size="Size.Large" Class="intern-dialog-avatar">
                                    @GetInitials(intern.Name, intern.Surname)
                                </MudAvatar>
                                
                                @* Name und Details *@
                                <MudStack Spacing="1" Style="flex: 1;">
                                    <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                                        @intern.Name @intern.Surname
                                    </MudText>
                                    @{
                                        var isActive = IsActiveOnDate(intern, SelectedDate);
                                        var teamName = GetTeamForDate(intern, SelectedDate);
                                        var hasTeam = !string.Equals(teamName, "Kein Team", StringComparison.Ordinal);
                                    }
                                    <div class="intern-meta-row">
                                        <div class="meta-pill meta-pill-date">
                                            <MudIcon Icon="@Icons.Material.Filled.DateRange" Size="Size.Small"/>
                                            <span>@intern.StartDate.ToString("dd.MM.yy") - @intern.EndDate.ToString("dd.MM.yy")</span>
                                        </div>
                                        <div class="@($"meta-pill {(isActive ? "meta-pill-active" : "meta-pill-muted")}")">
                                            <MudIcon Icon="@(isActive ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Circle)" Size="Size.Small"/>
                                            <span>@(isActive ? "An diesem Tag aktiv" : GetDaysRemaining(intern))</span>
                                        </div>
                                        @if (hasTeam) {
                                            <div class="team-label team-color-scope" style="@TeamColorHelper.GetHueStyle(teamName)">
                                                @teamName
                                            </div>
                                        }
                                        else {
                                            <div class="meta-pill meta-pill-muted">
                                                <MudIcon Icon="@Icons.Material.Filled.Groups" Size="Size.Small"/>
                                                <span>@teamName</span>
                                            </div>
                                        }
                                    </div>
                                </MudStack>
                            </MudStack>
                            
                            @* Progress Bar *@
                            <MudProgressLinear Color="Color.Primary" 
                                              Value="@GetProgress(intern)" 
                                              Class="mt-2" 
                                              Rounded="true"
                                              Size="Size.Small"/>
                        </MudPaper>
                    </MudItem>
                }
            </MudGrid>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">Schließen</MudButton>
        <AuthorizeView Policy="@Policies.Intern.CanRead">
            <Authorized>
                <MudButton OnClick="NavigateToManage" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.ManageAccounts">
                    Zur Verwaltung
                </MudButton>
            </Authorized>
        </AuthorizeView>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public List<InternDto> Interns { get; set; } = [];

    [Parameter]
    public string Date { get; set; } = string.Empty;

    [Parameter]
    public int Count { get; set; }

    [Parameter]
    public DateTime SelectedDate { get; set; }

    private void Cancel() => MudDialog.Cancel();

    private void NavigateToManage() => MudDialog.Close(DialogResult.Ok(true));

    private static string GetInitials(string name, string surname) {
        var firstInitial = !string.IsNullOrEmpty(name) ? name[0].ToString().ToUpper() : "?";
        var lastInitial = !string.IsNullOrEmpty(surname) ? surname[0].ToString().ToUpper() : "?";
        return firstInitial + lastInitial;
    }

    private static bool IsActiveOnDate(InternDto intern, DateTime date) {
        var day = date.Date;
        return intern.StartDate.Date <= day && intern.EndDate.Date >= day;
    }

    private static double GetProgress(InternDto intern) {
        var total = (intern.EndDate - intern.StartDate).TotalDays;
        if (total <= 0) {
            return 100;
        }

        var elapsed = (DateTime.Today - intern.StartDate).TotalDays;
        return Math.Min(100, Math.Max(0, (elapsed / total) * 100));
    }

    private static string GetDaysRemaining(InternDto intern) {
        var today = DateTime.Today;
        if (intern.EndDate.Date < today) {
            var daysAgo = (today - intern.EndDate.Date).Days;
            return $"Beendet vor {daysAgo} Tag{(daysAgo != 1 ? "en" : "")}";
        }
        if (intern.StartDate.Date > today) {
            var daysUntil = (intern.StartDate.Date - today).Days;
            return $"Beginnt in {daysUntil} Tag{(daysUntil != 1 ? "en" : "")}";
        }
        return "Status unbekannt";
    }

    private static string GetTeamForDate(InternDto intern, DateTime date) {
        return intern.DayAssignments.FirstOrDefault(x => x.Date.Date == date.Date)?.TeamName ?? "Kein Team";
    }
}

