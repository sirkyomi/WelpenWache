@page "/intern/manage"
@using WelpenWache.Core
@using WelpenWache.Core.Features.Intern
@using WelpenWache.Core.Features.Intern.Models
@inject IInternService InternService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@attribute [StreamRendering]
@attribute [Authorize(Policy = Policies.Intern.CanRead)]

<PageTitle>WelpenWache - @_interns.Count Praktikanten</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-8">
    <MudPaper Elevation="4" Class="pa-6">
        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-6">
            <MudIcon Icon="@Icons.Material.Filled.ManageAccounts" Color="Color.Primary" Size="Size.Large" />
            <div class="grow">
                <MudText Typo="Typo.h5">Praktikanten verwalten</MudText>
                <MudText Typo="Typo.caption" Class="mud-text-secondary">
                    @_interns.Count Praktikant@(_interns.Count != 1 ? "en" : "") im System
                </MudText>
            </div>
            <AuthorizeView Policy="@Policies.Intern.CanCreate">
                <Authorized>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Add"
                               OnClick="OpenCreateDialogAsync">
                        Hinzufügen
                    </MudButton>
                </Authorized>
            </AuthorizeView>
        </MudStack>

        <MudTable Items="@_interns"
                  Filter="new Func<InternDto, bool>(FilterInterns)"
                  Hover="true"
                  Breakpoint="Breakpoint.Sm"
                  Loading="@_loading"
                  Elevation="0">
            <ToolBarContent>
                <MudTextField @bind-Value="_searchString"
                              Placeholder="Suchen..."
                              Adornment="Adornment.Start"
                              AdornmentIcon="@Icons.Material.Filled.Search"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Immediate="true"
                              Style="max-width: 420px;" />
            </ToolBarContent>
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Zeitraum</MudTh>
                <MudTh>Teams</MudTh>
                <MudTh>Heute</MudTh>
                <MudTh></MudTh>
            </HeaderContent>
            <RowTemplate Context="intern">
                <MudTd DataLabel="Name">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudAvatar Color="Color.Primary" Size="Size.Small">
                            @GetInitials(intern.Name, intern.Surname)
                        </MudAvatar>
                        <MudText Typo="Typo.body2"><strong>@intern.Name @intern.Surname</strong></MudText>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Zeitraum">
                    <MudText Typo="Typo.body2">@intern.StartDate.ToString("dd.MM.yyyy") - @intern.EndDate.ToString("dd.MM.yyyy")</MudText>
                </MudTd>
                <MudTd DataLabel="Teams">
                    <MudText Typo="Typo.body2">@GetTeamSummary(intern)</MudText>
                </MudTd>
                <MudTd DataLabel="Heute">
                    @{
                        var teamToday = GetTeamForDate(intern, DateTime.Today);
                    }
                    @if (!string.IsNullOrWhiteSpace(teamToday)) {
                        <MudChip T="string" Color="Color.Info" Size="Size.Small">@teamToday</MudChip>
                    }
                    else {
                        <MudText Typo="Typo.caption" Class="mud-text-secondary">Kein Team</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Aktionen">
                    <MudStack Row="true" Spacing="1" Justify="Justify.FlexEnd">
                        <AuthorizeView Policy="@Policies.Intern.CanUpdate">
                            <Authorized>
                                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                               Color="Color.Primary"
                                               Size="Size.Small"
                                               OnClick="() => OpenEditDialogAsync(intern)" />
                            </Authorized>
                        </AuthorizeView>
                        <AuthorizeView Policy="@Policies.Intern.CanDelete">
                            <Authorized>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                               Color="Color.Error"
                                               Size="Size.Small"
                                               OnClick="() => DeleteInternAsync(intern)" />
                            </Authorized>
                        </AuthorizeView>
                    </MudStack>
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudAlert Severity="Severity.Info" Variant="Variant.Text">
                    Keine Praktikanten gefunden.
                </MudAlert>
            </NoRecordsContent>
        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    private readonly List<InternDto> _interns = [];
    private readonly DialogOptions _wizardDialogOptions = new() { MaxWidth = MaxWidth.ExtraLarge, FullWidth = true, CloseButton = true };
    private bool _loading = true;
    private string? _searchString;

    protected override async Task OnInitializedAsync() {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync() {
        _loading = true;
        try {
            var interns = await InternService.GetInternsAsync();
            _interns.Clear();
            _interns.AddRange(interns);
        }
        catch (Exception ex) {
            Snackbar.Add($"Fehler beim Laden der Praktikanten: {ex.Message}", Severity.Error);
        }
        finally {
            _loading = false;
        }
    }

    private async Task OpenCreateDialogAsync() {
        var dialog = await DialogService.ShowAsync<InternWizardDialog>("Praktikant hinzufügen", _wizardDialogOptions);
        var result = await dialog.Result;
        if (result is { Canceled: false }) {
            await LoadDataAsync();
        }
    }

    private async Task OpenEditDialogAsync(InternDto intern) {
        var parameters = new DialogParameters {
            ["InternToEdit"] = intern
        };

        var dialog = await DialogService.ShowAsync<InternWizardDialog>("Praktikant bearbeiten", parameters, _wizardDialogOptions);
        var result = await dialog.Result;
        if (result is { Canceled: false }) {
            await LoadDataAsync();
        }
    }

    private async Task DeleteInternAsync(InternDto intern) {
        try {
            await InternService.DeleteInternAsync(intern.Id);
            _interns.Remove(intern);
            Snackbar.Add($"{intern.Name} {intern.Surname} wurde gelöscht.", Severity.Success);
        }
        catch (Exception ex) {
            Snackbar.Add($"Fehler beim Löschen: {ex.Message}", Severity.Error);
        }
    }

    private bool FilterInterns(InternDto intern) {
        if (string.IsNullOrWhiteSpace(_searchString)) {
            return true;
        }

        var search = _searchString.Trim();
        return intern.Name.Contains(search, StringComparison.OrdinalIgnoreCase)
               || intern.Surname.Contains(search, StringComparison.OrdinalIgnoreCase)
               || $"{intern.Name} {intern.Surname}".Contains(search, StringComparison.OrdinalIgnoreCase)
               || GetTeamSummary(intern).Contains(search, StringComparison.OrdinalIgnoreCase);
    }

    private static string GetTeamSummary(InternDto intern) {
        var teamNames = intern.DayAssignments
            .Select(x => x.TeamName)
            .Where(x => !string.IsNullOrWhiteSpace(x))
            .Distinct()
            .OrderBy(x => x)
            .ToList();

        return teamNames.Count == 0 ? "Kein Team" : string.Join(", ", teamNames);
    }

    private static string? GetTeamForDate(InternDto intern, DateTime date) {
        return intern.DayAssignments
            .FirstOrDefault(x => x.Date.Date == date.Date)
            ?.TeamName;
    }

    private static string GetInitials(string name, string surname) {
        var firstInitial = !string.IsNullOrEmpty(name) ? name[0].ToString().ToUpper() : "?";
        var lastInitial = !string.IsNullOrEmpty(surname) ? surname[0].ToString().ToUpper() : "?";
        return firstInitial + lastInitial;
    }
}

